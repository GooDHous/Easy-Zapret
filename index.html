Write-Host "Hello from ywteam.ru!"
Get-Process
@echo off
chcp 65001
setlocal enabledelayedexpansion

color 0A

if "%1"=="admin" (
    cd /d "%~dp0"
) else (

    powershell -Command "Start-Process 'cmd.exe' -ArgumentList '/c \"\"%~f0\" admin\"' -Verb RunAs"
    exit /b
)

set "ZAPRET_DIR=C:\Zapret"
set "TEMP_DIR=%TEMP%\ZapretInstaller"
set "OLD_DIR=C:\zapret-discord-youtube-main"
set "ZAPRET_URL=https://codeload.github.com/Flowseal/zapret-discord-youtube/zip/refs/heads/main"
set "HOSTS_LIST_URL=https://raw.githubusercontent.com/GooDHous/HostsList/refs/heads/main/hosts.txt"

set "LOG_FILE=%TEMP_DIR%\zapret_install.log"

if not exist "%TEMP_DIR%" (
    mkdir "%TEMP_DIR%" >nul 2>&1
)

call :log "=== РќР°С‡Р°Р»Рѕ СѓСЃС‚Р°РЅРѕРІРєРё Zapret ==="

call :check_admin
if errorlevel 1 (
    pause
    exit /b 1
)

taskkill /f /im winws.exe >nul 2>&1
if !errorlevel! equ 0 (
    echo [INFO] РџСЂРѕС†РµСЃСЃ winws.exe РѕСЃС‚Р°РЅРѕРІР»РµРЅ
) else (
    echo [INFO] РџСЂРѕС†РµСЃСЃ winws.exe РЅРµ РЅР°Р№РґРµРЅ
)

echo [INFO] РћСЃС‚Р°РЅРѕРІРєР° СЃР»СѓР¶Р± Рё РїСЂРѕС†РµСЃСЃРѕРІ Zapret...
call :log "РћСЃС‚Р°РЅРѕРІРєР° СЃР»СѓР¶Р± Zapret..."
sc stop zapret >nul
sc stop windivert >nul
timeout /t 3 /nobreak
sc delete zapret >nul
sc delete windivert >nul

echo.
echo [INFO] РџСЂРѕРІРµСЂРєР° Рё СѓРґР°Р»РµРЅРёРµ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёС… СѓСЃС‚Р°РЅРѕРІРѕРє...
call :clean_directory "%ZAPRET_DIR%"
call :clean_directory "%OLD_DIR%"

echo.

echo [INFO] Р—Р°РіСЂСѓР·РєР° Р°СЂС…РёРІР° Zapret...
powershell -Command "Invoke-WebRequest -Uri '%ZAPRET_URL%' -OutFile '%TEMP_DIR%\Zapret.zip' -UseBasicParsing"
if exist "%TEMP_DIR%\Zapret.zip" (
    echo [SUCCESS] РђСЂС…РёРІ Zapret Р·Р°РіСЂСѓР¶РµРЅ
) else (
    echo [ERROR] РќРµ СѓРґР°Р»РѕСЃСЊ Р·Р°РіСЂСѓР·РёС‚СЊ Р°СЂС…РёРІ Zapret
    goto :error
)

echo [INFO] Р—Р°РіСЂСѓР·РєР° СЃРїРёСЃРєР° С…РѕСЃС‚РѕРІ...
powershell -Command "Invoke-WebRequest -Uri '%HOSTS_LIST_URL%' -OutFile '%TEMP_DIR%\list-general.txt' -UseBasicParsing"
if exist "%TEMP_DIR%\list-general.txt" (
    echo [SUCCESS] РЎРїРёСЃРѕРє С…РѕСЃС‚РѕРІ Р·Р°РіСЂСѓР¶РµРЅ
) else (
    echo [WARNING] РќРµ СѓРґР°Р»РѕСЃСЊ Р·Р°РіСЂСѓР·РёС‚СЊ СЃРїРёСЃРѕРє С…РѕСЃС‚РѕРІ, РїСЂРѕРґРѕР»Р¶РёРј Р±РµР· РЅРµРіРѕ
)

for %%F in ("%TEMP_DIR%\Zapret.zip") do set "size=%%~zF"
if "!size!"=="0" (
    goto :error
)

echo.
echo [INFO] Р Р°СЃРїР°РєРѕРІРєР° Р°СЂС…РёРІР°...
powershell -Command "Expand-Archive -Path '%TEMP_DIR%\Zapret.zip' -DestinationPath 'C:\' -Force"
if !errorlevel! neq 0 (
    goto :error
)


if not exist "%OLD_DIR%" (
    echo [ERROR] РџРѕСЃР»Рµ СЂР°СЃРїР°РєРѕРІРєРё РїР°РїРєР° РЅРµ РЅР°Р№РґРµРЅР°: %OLD_DIR%
    goto :error
)

if exist "%OLD_DIR%" (
    echo [INFO] РџРµСЂРµРёРјРµРЅРѕРІР°РЅРёРµ РїР°РїРєРё...
    ren "%OLD_DIR%" "Zapret" >nul 2>&1
    if !errorlevel! neq 0 (
        echo [ERROR] РќРµ СѓРґР°Р»РѕСЃСЊ РїРµСЂРµРёРјРµРЅРѕРІР°С‚СЊ РїР°РїРєСѓ"
        goto :error
    )
)

if exist "%TEMP_DIR%\list-general.txt" (
    if not exist "%ZAPRET_DIR%\lists" (
        mkdir "%ZAPRET_DIR%\lists" >nul 2>&1
    )
    copy /Y "%TEMP_DIR%\list-general.txt" "%ZAPRET_DIR%\lists\" >nul
    if !errorlevel! equ 0 (
        echo [INFO] Р¤Р°Р№Р» СЃРїРёСЃРєР° С…РѕСЃС‚РѕРІ СѓСЃРїРµС€РЅРѕ СЃРєРѕРїРёСЂРѕРІР°РЅ
    )
)

echo.
echo [INFO] Р—Р°РїСѓСЃРє СЃРµСЂРІРёСЃР° Zapret...
cd /d "%ZAPRET_DIR%"
if exist "service.bat" (
    call "service.bat"
    echo [SUCCESS] РЎРµСЂРІРёСЃ СѓСЃРїРµС€РЅРѕ Р·Р°РїСѓС‰РµРЅ!
    
    :: РџСЂРѕРІРµСЂСЏРµРј Р·Р°РїСѓСЃС‚РёР»РёСЃСЊ Р»Рё СЃР»СѓР¶Р±С‹
    timeout /t 5 /nobreak >nul
    for %%S in (zapret windivert) do (
        sc query "%%S" >nul 2>&1
        if !errorlevel! equ 0 (
            echo [INFO] РЎР»СѓР¶Р±Р° %%S Р·Р°РїСѓС‰РµРЅР°
        ) else (
            echo [WARNING] РЎР»СѓР¶Р±Р° %%S РЅРµ Р·Р°РїСѓС‰РµРЅР°
        )
    )
) else (
    echo [ERROR] Р¤Р°Р№Р» service.bat РЅРµ РЅР°Р№РґРµРЅ!
    goto :error
)

:: РћС‡РёСЃС‚РєР° РІСЂРµРјРµРЅРЅС‹С… С„Р°Р№Р»РѕРІ
echo.
echo [INFO] РћС‡РёСЃС‚РєР° РІСЂРµРјРµРЅРЅС‹С… С„Р°Р№Р»РѕРІ...
if exist "%TEMP_DIR%" (
    rd /s /q "%TEMP_DIR%" >nul 2>&1
)

echo.
echo ===============================================
echo [SUCCESS] РЈСЃС‚Р°РЅРѕРІРєР° Zapret Р·Р°РІРµСЂС€РµРЅР° СѓСЃРїРµС€РЅРѕ!
echo ===============================================
echo.
call :log "=== РЈСЃС‚Р°РЅРѕРІРєР° Р·Р°РІРµСЂС€РµРЅР° СѓСЃРїРµС€РЅРѕ ==="
timeout /t 5 >nul
exit /b 0

:error
echo.
echo ===============================================
echo [ERROR] Р’ РїСЂРѕС†РµСЃСЃРµ СѓСЃС‚Р°РЅРѕРІРєРё РїСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°
if defined LOG_FILE echo РџСЂРѕРІРµСЂСЊС‚Рµ С„Р°Р№Р» Р»РѕРіР°: %LOG_FILE%
echo ===============================================
call :log "=== РЈСЃС‚Р°РЅРѕРІРєР° Р·Р°РІРµСЂС€РµРЅР° СЃ РѕС€РёР±РєР°РјРё ==="
pause
exit /b 1

:check_admin
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo [ERROR] РўСЂРµР±СѓСЋС‚СЃСЏ РїСЂР°РІР° Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂР°
    exit /b 1
)
exit /b 0

:clean_directory
if exist "%~1" (
    echo [INFO] РЈРґР°Р»РµРЅРёРµ РїР°РїРєРё %~1...
    rmdir /s /q "%~1" >nul 2>&1
    if !errorlevel! equ 0 (
        echo [SUCCESS] РџР°РїРєР° %~1 СѓРґР°Р»РµРЅР°
        call :log "РЈРґР°Р»РµРЅР° РїР°РїРєР°: %~1"
    ) else (
        echo [ERROR] РќРµ СѓРґР°Р»РѕСЃСЊ СѓРґР°Р»РёС‚СЊ РїР°РїРєСѓ %~1
        call :log "РћС€РёР±РєР° СѓРґР°Р»РµРЅРёСЏ РїР°РїРєРё: %~1"
        
        :: РџРѕРїСЂРѕР±СѓРµРј С‡РµСЂРµР· PowerShell
        echo [INFO] РџРѕРїС‹С‚РєР° СѓРґР°Р»РµРЅРёСЏ С‡РµСЂРµР· PowerShell...
        powershell -Command "Remove-Item '%~1' -Recurse -Force" >nul 2>&1
        if !errorlevel! equ 0 (
            echo [SUCCESS] РџР°РїРєР° СѓРґР°Р»РµРЅР° С‡РµСЂРµР· PowerShell
        )
    )
)
exit /b 0

:download_file
set "url=%~1"
set "output=%~2"
echo [INFO] Р—Р°РіСЂСѓР·РєР°: %url%
curl -f -L -o "%output%" "%url%" >nul 2>&1
if !errorlevel! equ 0 (
    if exist "%output%" (
        for %%F in ("%output%") do if %%~zF gtr 0 (
            echo [SUCCESS] Р¤Р°Р№Р» Р·Р°РіСЂСѓР¶РµРЅ: %output%
            call :log "Р—Р°РіСЂСѓР¶РµРЅ С„Р°Р№Р»: %output%"
            exit /b 0
        )
    )
)
echo [ERROR] РћС€РёР±РєР° Р·Р°РіСЂСѓР·РєРё: %url%
call :log "РћС€РёР±РєР° Р·Р°РіСЂСѓР·РєРё: %url%"
exit /b 1

:log
if defined LOG_FILE (
    echo [%date% %time%] %~1 >> "%LOG_FILE%"
)
exit /b 0